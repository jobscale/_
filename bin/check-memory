#!/usr/bin/env bash
set -eu

closeBrowser() {
  echo "Try killing Chrome"
  local BROWSER_PIDS=( $(pgrep -f '/google/chrome' || true) )
  if [[ ${#BROWSER_PIDS[@]} -gt 0 ]]; then
    kill ${BROWSER_PIDS[@]} || echo "Warning: Failed to kill Chrome"
    echo "Killed Chrome processes: ${BROWSER_PIDS[@]}"
  else
    echo "No Chrome processes found"
  fi

  echo "Try killing FireFox"
  local BROWSER_PIDS=( $(pgrep -f '/firefox' || true) )
  if [[ ${#BROWSER_PIDS[@]} -gt 0 ]]; then
    kill ${BROWSER_PIDS[@]} || echo "Warning: Failed to kill FireFox"
    echo "Killed FireFox processes: ${BROWSER_PIDS[@]}"
  else
    echo "No FireFox processes found"
  fi
}

webPush() {
  local MESSAGE="$(hostname) - [Memory low] Available memory is $1 threshold"
  echo "Sending web push notification: $MESSAGE"
  web-push "$MESSAGE"
}

checkMemory() {
  sleep 2.2
  threshold_web_push=600
  threshold_close=300
  while true
  do
    echo -n "$(TZ=Asia/Tokyo date -Iseconds) "
    read -r mib gib <<< "$(free -m | awk '/^Mem:/ {printf "%d %.2f", $7, $7 / 1024}')"
    if [[ "${mib}" -lt "$threshold_close" ]]
    then
      echo "Available memory is critically low (< $threshold_close MiB): ${mib} MiB ${gib} GiB"
      closeBrowser
    elif [[ "${mib}" -lt "$threshold_web_push" ]]
    then
      echo "Available memory is low (< $threshold_web_push MiB): ${mib} MiB ${gib} GiB"
      webPush "${mib}"
    else
      echo "Available memory is sufficient: ${mib} MiB ${gib} GiB"
    fi
    sleep 12.34
  done
}

{
  checkMemory
}
