#!/usr/bin/env bash
set -eu

wait-of-busy() {
  awk '
  BEGIN {
    count=5
    while (1) {
      cmd = "mpstat 1 1 | tail -1"
      while ((cmd | getline) > 0) {
        idle = $NF
        idle_int = int(idle)
        if (idle_int >= 80) {
          count--
          printf "%3d", count
        } else {
          count=5
          cmd2 = "date -Iseconds"
          cmd2 | getline now
          close(cmd2)
          print now, "wait for busy CPU", idle_int, count
          system("sleep 2")
        }
        close(cmd)
        break
      }
      if (count <= 0) {
        print ""
        break
      }
      system("sleep 0.1")
    }
  }'
}

wait-of-busy
