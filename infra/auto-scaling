#!/usr/bin/env bash

ddns() {
  docker pull ghcr.io/jobscale/value-domain
  docker run --rm -e ENV=${ENV} -t ghcr.io/jobscale/value-domain
  {
    sleep 30
    docker run --rm -e ENV=${ENV} -t ghcr.io/jobscale/value-domain
    sleep 30
    docker run --rm -e ENV=${ENV} -t ghcr.io/jobscale/value-domain
  } &
}

ddns-dev() {
  /usr/local/bin/noip2
  ddns
}

ddns-prod() {
  ddns
}

{
  echo "AutoScaling EC2 - ${ENV:+dev} $(date -Iseconds)"
  hostname "$ENV"
  echo "$ENV" | tee /etc/hostname
  ddns-$(ENV)
  CHANNEL=infra /root/_/bin/post-slack "AutoScaling EC2 - ${ENV}" &
}
