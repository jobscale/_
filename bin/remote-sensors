#!/usr/bin/env bash
set -eu

dark-cpu-info() {
  LANG=ja_JP.UTF-8 sensors | awk '/Package/ {print $4}'
  LANG=ja_JP.UTF-8 sensors | awk '
    /Tctl/ { cpu = $2 }
    /Sensor 1/ { nvme1 = $3 }
    /Sensor 2/ { nvme2 = $3 }
    /temp1/ { wifi = $2 }
    /edge/ { gpu = $2 }
    END {
      printf "%s %s %s %s\n", cpu, (nvme1 > nvme2) ? nvme1 : nvme2, wifi, gpu
    }'
  LANG=C mpstat 1 1 | awk '/Average/ {printf "%d\n", 100 - $NF}'
  LANG=C sar -n DEV --iface=wlp3s0 1 1 | tail -1 | awk '{printf "%.2fMiB %d\n", $5 / 1024, $NF * 2}'
}

n100-cpu-info() {
  LANG=ja_JP.UTF-8 sensors | awk '/Package/ {print $4}'
  LANG=C mpstat 1 1 | awk '/Average/ {printf "%d\n", 100 - $NF}'
  LANG=C sar -n DEV --iface=enp1s0 1 1 | tail -1 | awk '{printf "%.2fMiB %d\n", $5 / 1024, $NF * 2}'
}

mac-traffic() {
  first_run_bytes=$(netstat -b -I en0 | awk '/^en0/{print $7, $10; exit}')
  rx_bytes_1=$(echo "$first_run_bytes" | awk '{print $1}')
  tx_bytes_1=$(echo "$first_run_bytes" | awk '{print $2}')
  sleep 1
  second_run_bytes=$(netstat -b -I en0 | awk '/^en0/{print $7, $10; exit}')
  rx_bytes_2=$(echo "$second_run_bytes" | awk '{print $1}')
  tx_bytes_2=$(echo "$second_run_bytes" | awk '{print $2}')

  rx_rate=$(echo "scale=3; ($rx_bytes_2 - $rx_bytes_1) / 1024 / 1024" | bc)
  tx_rate=$(echo "scale=3; ($tx_bytes_2 - $tx_bytes_1) / 1024 / 1024" | bc)

  printf "%.2fMiB\n" "$rx_rate"
  printf "%.2fMiB\n" "$tx_rate"
}

mac-cpu-info() {
  sudo powermetrics -n 1 --samplers smc 2>/dev/null | grep 'CPU die temperature:' | awk '{printf "%.1fâ„ƒ\n", $4}'
  iostat -w 1 -c 2 | tail -1 | awk '{printf "%d\n", 100 - $6}'
  mac-traffic
}

DATA=(
  $($(uname -n)-cpu-info)
)

echo ${DATA[@]}
