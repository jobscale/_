#!/usr/bin/env bash
set -eu

closeBrowser() {
  echo "Try killing Chrome"
  local BROWSER_PIDS=( $(pgrep -f '/google-chrome' || true) )
  if [[ ${#BROWSER_PIDS[@]} -gt 0 ]]; then
    kill ${BROWSER_PIDS[@]} || echo "Warning: Failed to kill Chrome"
    echo "Killed Chrome processes: ${BROWSER_PIDS[@]}"
  else
    echo "No Chrome processes found"
  fi

  echo "Try killing FireFox"
  local BROWSER_PIDS=( $(pgrep -f '/firefox' || true) )
  if [[ ${#BROWSER_PIDS[@]} -gt 0 ]]; then
    kill ${BROWSER_PIDS[@]} || echo "Warning: Failed to kill FireFox"
    echo "Killed FireFox processes: ${BROWSER_PIDS[@]}"
  else
    echo "No FireFox processes found"
  fi
}

checkMemory() {
  sleep 2.2
  threshold=300
  while true
  do
    echo -n "$(TZ=Asia/Tokyo date -Iseconds) "
    read -r mib gib <<< "$(free -m | awk '/^Mem:/ {printf "%d %.2f", $7, $7 / 1024}')"
    if [[ "${mib}" -lt "$threshold" ]]
    then
      echo "Available memory is less than $threshold MiB: ${mib} MiB ${gib} GiB"
      closeBrowser
    else
      echo "Available memory is sufficient: ${mib} MiB ${gib} GiB"
    fi
    sleep 12.34
  done
}

{
  checkMemory
}
