#!/usr/bin/env bash
set -eux

export DEBIAN_FRONTEND=noninteractive

debian-2022() {
  apt-get update
  apt-get install -y --no-install-recommends apt-transport-https
  apt-get update
  apt-get full-upgrade -y --no-install-recommends
  apt-get install -y --no-install-recommends \
    curl git vim tmux htop expect \
    iproute2 dnsutils ncat netcat iputils-ping \
    nmap traceroute procps whois progress \
    python3-pip bc jq zip unzip tree colordiff \
    openssh-server bash-completion
  apt-get autoremove -y
  [[ ! -d ~/_ ]] && git clone https://github.com/jobscale/_.git ~/_ || echo
}

debian-2023() {
  apt-get update
  apt-get install -y --no-install-recommends apt-transport-https
  apt-get update
  apt-get full-upgrade -y --no-install-recommends
  apt-get install -y --no-install-recommends \
    curl git vim tmux htop expect \
    iproute2 dnsutils ncat netcat-openbsd iputils-ping \
    nmap traceroute procps whois progress \
    python3-pip bc jq zip unzip tree colordiff \
    openssh-server bash-completion
  apt-get autoremove -y
  [[ ! -d ~/_ ]] && git clone https://github.com/jobscale/_.git ~/_ || echo
}

network-manager() {
  apt-get install -y --no-install-recommends network-manager
}

main() {
  echo "$(lsb_release -a 2>/dev/null || echo "$(date --rfc-3339=seconds) [WARN] No LSB modules are available.")"
  . /etc/os-release

  start() {
    echo "$(date --rfc-3339=seconds) [INFO] START  stable for $VERSION_CODENAME"
  }
  finish() {
    echo "$(date --rfc-3339=seconds) [INFO] FINISH stable for $VERSION_CODENAME"
  }
  trap 'finish' EXIT
  start

  case "$VERSION_CODENAME" in
    trixie|bookworm|noble|kali-rolling)
      debian-2023
      network-manager
      ;;
    bullseye|buster|focal|bionic|xenial|trusty|jammy)
      debian-2022
      [[ "$VERSION_CODENAME" =~ ^(bullseye|buster)$ ]] && network-manager
      ;;
    *)
      echo "$(date --rfc-3339=seconds) [FAIL] Unsupported distribution: $VERSION_CODENAME"
      exit 1
      ;;
  esac
}

main "$@"
