#!/usr/bin/env bash
set -u

DEVICE=eno1

main() {
  # ifb モジュールをロード
  sudo modprobe ifb numifbs=1 # or - sudo modprobe ifb

  # ifb0 を有効化
  sudo ip link set dev ifb0 up

  # qdisc ingress を追加
  sudo tc qdisc add dev ${DEVICE} ingress
  # eth0（例）から ifb0 に受信トラフィックをリダイレクト
  sudo tc filter add dev ${DEVICE} parent ffff: \
    protocol ip u32 match u32 0 0 \
    action mirred egress redirect dev ifb0

  # ifb0 に帯域制限を設定（2MiB/sec）
  sudo tc qdisc add dev ifb0 root tbf rate 32Mbit burst 64kbit limit 128kbit
}

show() {
  sudo tc qdisc show dev ifb0
}

update() {
  sudo tc qdisc change dev ifb0 root tbf rate 72Mbit burst 256kbit limit 512kbit
}

clean() {
  # 制限を削除
  sudo tc qdisc del dev ifb0 root
  # リダイレクト・フィルターを削除
  sudo tc filter del dev eno1 parent ffff:
  # qdisc ingress を削除
  sudo tc qdisc del dev eno1 ingress
  # ifb0 を削除
  sudo ip link set dev ifb0 down
}

main
